#include "precompiled_engine.h"

#ifndef _ITF_NETWORKSERVICES_PS3_H_
#include "engine/NetworkServices/PS3/NetworkServices_PS3.h"
#endif //_ITF_NETWORKSERVICES_PS3_H_

#ifndef _ITF_GAMEMANAGER_H_
#include "gameplay/Managers/GameManager.h"
#endif //_ITF_GAMEMANAGER_H_

#ifndef _ITF_SYSTEMADAPTER_PS3_H_
#include "adapters/SystemAdapter_PS3/SystemAdapter_PS3.h"
#endif //_ITF_SYSTEMADAPTER_PS3_H_

#ifndef _ITF_ONLINETRACKINGADAPTER_H
#include "engine/AdaptersInterfaces/OnlineTrackingAdapter.h"
#endif //_ITF_ONLINETRACKINGADAPTER_H

#ifndef _ITF_MODULEMANAGER_PS3_H_
#include "core/system/PS3/ModuleManager_ps3.h"
#endif //_ITF_MODULEMANAGER_PS3_H_

#include <cell/sysmodule.h>
#include "np.h"
#include <netex/net.h>

namespace ITF
{
	// Rayman Origins SCEE (other versions use the same ServiceId for ticketing)
	// 
	const char *PS3_TITLE_ID = "EP0001-BLES01386_00";

	const size_t NP_POOL_SIZE = 128*1024;
	const size_t TICKET_PENDING = ~0;

	void npManagerCallback(int event, int result, void* arg)
	{
		NetworkServices_PS3 *obj = (NetworkServices_PS3*)arg;
		ITF_ASSERT(obj);
		if (obj)
			obj->onNpManagerCallback(event, result);
	}


	NetworkServices_PS3::NetworkServices_PS3() :
		m_npOnline(false), m_npPool(NULL), m_npTicket(NULL), m_npTicketSize(0)
    {
	}

	NetworkServices_PS3::~NetworkServices_PS3()
	{
		if (m_npTicket)
		{
			delete [] m_npTicket;
			m_npTicket = NULL;
			m_npTicketSize = 0;
		}
	}

    void NetworkServices_PS3::initialize( u32 dwMinUsers,u32 dwMaxUsers,bbool bRequireOnlineUsers,u32 dwSignInPanes )
    {
		MODULE_MANAGER->loadModule(CELL_SYSMODULE_SYSUTIL_NP);
		m_npPool = new char [NP_POOL_SIZE];
		ITF_ASSERT(m_npPool != NULL);
		ITF_VERIFY(0 == sceNpInit(NP_POOL_SIZE, m_npPool));
		ITF_VERIFY(0 == sceNpManagerRegisterCallback(npManagerCallback, this)); // caution: exclusive
		int connectionState;
		ITF_VERIFY(0 == sceNpManagerGetStatus(&connectionState));
		if (connectionState == SCE_NP_MANAGER_STATUS_ONLINE)
			m_npOnline = true; // to be consistent with X360: callback not launched if already signed in at startup

#ifdef ITF_SUPPORT_ONLINETRACKING 
        // Init network
        i32 ret;
        ret = MODULE_MANAGER->loadModule(CELL_SYSMODULE_NET);
        if (ret < 0)
        {
            LOG("cellSysmoduleLoadModule() failed (%d)\n", ret);
            return ;
        }

        ret = sys_net_initialize_network();
        if (ret < 0)
        {
            LOG("sys_net_initialize_network() failed (%d)\n", ret);
            return ;
        }
#endif
	}
        
    void NetworkServices_PS3::terminate()
    {
		sceNpTerm();
		delete [] m_npPool;
		m_npPool = NULL;

        // sys_net_finalize_network(); // TODO: test if Rendez-Vous’ termination is happy with that

		MODULE_MANAGER->unloadModule(CELL_SYSMODULE_SYSUTIL_NP);
    }

	void NetworkServices_PS3::onNpManagerCallback(int event, int result)
	{
		switch (event)
		{
		case SCE_NP_MANAGER_STATUS_ONLINE:
			if (m_npOnline) // can have been set by initialize()
				break;
			m_npOnline = true;
			//GAMEMANAGER->userSignedInOut(0, btrue, btrue); // return value is X360-TCR-specific, ignored
			break;
		case SCE_NP_MANAGER_STATUS_OFFLINE:
			if (!m_npOnline)
				break;
			m_npOnline = false;
			//GAMEMANAGER->userSignedInOut(0, bfalse, btrue); // return value is X360-TCR-specific, ignored
			break;
		case SCE_NP_MANAGER_EVENT_GOT_TICKET:
			onTicketResult(result);
			break;
		default:;
		}
	}

	void NetworkServices_PS3::onTicketResult(int result)
	{
		if (m_npTicketSize != TICKET_PENDING)
			return;

		if (result < 0)
		{
			LOG("Invalid NP Ticket: result=%x", result);
			m_npTicketSize = 0; // restart requesting ticket next time
		}
		else
			m_npTicketSize = (size_t)result;
	}

	bool NetworkServices_PS3::getRequestTicket(char **npTicket, size_t *npTicketSize)
	{
		if (m_npTicket)
		{
			// Already got ticket, return it
			*npTicket = m_npTicket;
			*npTicketSize = m_npTicketSize;
			return true;
		}
		
		if (m_npTicketSize == 0)
		{
			// Start requesting ticket
			int npStatus = -2;
			int ret = sceNpManagerGetStatus(&npStatus);
			if ((ret != 0) || (npStatus != SCE_NP_MANAGER_STATUS_ONLINE))
				return NULL;
			SceNpId npId;
			if (sceNpManagerGetNpId(&npId) != 0)
				return NULL;
			m_npTicketSize = TICKET_PENDING;
			ret = sceNpManagerRequestTicket(&npId, PS3_TITLE_ID, NULL, 0, NULL, 0);
			ITF_ASSERT(ret == 0);
			return false; // onTicketResult() will fill m_npTicket
		}
		else if (m_npTicketSize == TICKET_PENDING)
			return false;
		else
		{
			// Ticket received, ok to proceed
			m_npTicket = new char [m_npTicketSize];
			int ret = sceNpManagerGetTicket(m_npTicket, &m_npTicketSize);
			if (ret != 0)
			{
				LOG("Could not request NP Ticket (%x)", ret);
				delete [] m_npTicket;
				m_npTicket = NULL;
				m_npTicketSize = 0;
				return false;
			}
			*npTicket = m_npTicket;
			*npTicketSize = m_npTicketSize;
			return true;
		}
	}

    u32 NetworkServices_PS3::update()
    {
        return 0;
    }

    /***
    SceNpCommunicationId
    ***/
    const SceNpCommunicationId NetworkServices_PS3::s_communication_id[] =
    {
        {
            // //NPWR02249_00  Product Master
            {'N', 'P', 'W', 'R', '0', '2', '2', '4', '9'},  
            '\0',
            0,
            0
        },
        {   // //NPWR02836_00 Product_Jap
            {'N', 'P', 'W', 'R', '0', '2', '8', '3', '6'},
            '\0',
            0,
            0
        },
        {   // //NPWR02839_00 Product_PolRus
            {'N', 'P', 'W', 'R', '0', '2', '8', '3', '9'},
            '\0',
            0,
            0
        }
    };

    /***
    SceNpCommunicationSignature
    ***/
    const SceNpCommunicationSignature NetworkServices_PS3::s_communication_sig[] =
    {
        {  //Product Master
            0xb9,0xdd,0xe1,0x3b,0x01,0x00,0x00,0x00,
            0x00,0x00,0x00,0x00,0xad,0xce,0x4f,0x77,
            0xc1,0xce,0xa1,0xb5,0x35,0xb4,0xb4,0x9c,
            0x3d,0x00,0x79,0xe5,0x97,0x68,0x38,0xda,
            0xa8,0x7e,0x0a,0xbd,0x48,0x0d,0x89,0x5f,
            0x68,0xc6,0xa6,0x2f,0x3a,0x00,0x23,0xa1,
            0x87,0xa9,0x95,0x0a,0x10,0xbc,0x2d,0xa8,
            0xba,0xb8,0x65,0x9a,0xcb,0xb4,0x16,0x7e,
            0x34,0x58,0x62,0xf2,0x17,0x73,0x4c,0x65,
            0x79,0xe8,0x76,0x9d,0xe4,0xf1,0x15,0x10,
            0x05,0x59,0x54,0xfa,0xcd,0x4d,0xe8,0x1f,
            0x31,0x4c,0x9d,0xa1,0xc4,0xe1,0xb6,0x8e,
            0x29,0x71,0xe9,0x6f,0x6b,0x22,0x63,0xe1,
            0x02,0x06,0x91,0x8d,0xaf,0x78,0xb8,0x07,
            0xe8,0x0d,0xd3,0x8a,0x27,0x67,0x34,0x8e,
            0x18,0x54,0x87,0x93,0x89,0x77,0xad,0x90,
            0x49,0xca,0xe6,0xe2,0xe5,0xeb,0x06,0xba,
            0xd8,0x8d,0xb8,0xc6,0xe1,0xbe,0xe4,0xc1,
            0x8f,0x6b,0x52,0xca,0x87,0x88,0x97,0xff,
            0xc2,0x8c,0x95,0x16,0xe2,0xcf,0x8e,0xcc
        },
        {  //Product_Jap
            0xb9,0xdd,0xe1,0x3b,0x01,0x00,0x00,0x00,
            0x00,0x00,0x00,0x00,0x25,0xde,0xbd,0x23,
            0x39,0xbd,0xc6,0x94,0x99,0x63,0x1e,0xd9,
            0xbd,0x78,0x38,0x2f,0xf2,0x67,0xb1,0x3f,
            0x6b,0x64,0x34,0xd2,0x28,0xf3,0x9a,0x4e,
            0x53,0xf7,0xb1,0xfc,0x9b,0x66,0x9c,0x88,
            0x05,0xe1,0x78,0xa6,0xac,0x48,0x07,0x0a,
            0x63,0x60,0x94,0x96,0xcf,0x43,0xe5,0x0e,
            0xce,0x2b,0xc2,0xb9,0x99,0xe4,0x3d,0x82,
            0x2a,0x1e,0x16,0xe1,0x3b,0x16,0xf1,0xef,
            0xf8,0x3b,0xd8,0xa6,0xeb,0xe5,0x6a,0x1a,
            0xaa,0x26,0x95,0xdb,0x1f,0xa0,0xe7,0x34,
            0x20,0x92,0xe7,0x8c,0x59,0x3b,0x26,0x9e,
            0xdc,0x11,0xde,0x1c,0x66,0x64,0x85,0xcf,
            0x4a,0x9c,0x99,0xfe,0x83,0xe9,0xc9,0x15,
            0x06,0x93,0xd2,0xfd,0xf1,0xa8,0xb0,0x65,
            0x7b,0x56,0xfb,0xb8,0x91,0xb7,0x58,0x75,
            0xaa,0xa0,0xaa,0x62,0x2a,0x0c,0x0f,0x9d,
            0x81,0x39,0x2d,0x07,0x12,0x22,0xab,0xcd,
            0x66,0x9d,0xe7,0x88,0xd1,0x69,0xd7,0xe1
        },
        {   //Product_PolRussian
            0xb9,0xdd,0xe1,0x3b,0x01,0x00,0x00,0x00,
            0x00,0x00,0x00,0x00,0xe3,0x2b,0xdb,0xd8,
            0xed,0x0a,0xdb,0x6f,0x3d,0x92,0x6e,0x8c,
            0x2f,0x61,0x50,0x77,0x9c,0x31,0xa3,0x3f,
            0x8c,0x62,0xa6,0x17,0x14,0x2e,0x99,0x9b,
            0xf4,0xa3,0x6d,0x42,0xf1,0xa2,0xd2,0x5b,
            0x12,0x2e,0x37,0xd6,0xdc,0xa8,0x7b,0x3d,
            0x9a,0x54,0x97,0x2f,0xc1,0xe7,0x74,0x41,
            0xb3,0x54,0x60,0x9f,0xd0,0x6d,0xfc,0x2e,
            0x75,0xfc,0x12,0x8a,0xc3,0xb9,0xf7,0x88,
            0x8e,0x33,0x4f,0xb8,0x12,0x21,0x4f,0x5e,
            0xb1,0x98,0x5d,0xb2,0xbf,0x07,0x4d,0xa1,
            0x7d,0xe7,0x2f,0x37,0x4a,0xda,0xa0,0x77,
            0x8d,0xe5,0x4e,0xae,0x56,0xf7,0x77,0x81,
            0xd1,0x31,0xd8,0x5e,0x2b,0x5a,0x90,0x4f,
            0x91,0x3e,0x30,0x69,0x02,0xac,0x37,0xf3,
            0x76,0xf1,0x7b,0xd4,0x37,0x13,0xda,0x15,
            0x3b,0x2e,0xf3,0xcf,0xe1,0xbf,0x13,0x7c,
            0xff,0xc8,0x3c,0xaf,0xd1,0x22,0x9a,0x3a,
            0x06,0x29,0xcd,0x94,0x48,0x17,0xff,0xf8
        }
    };

} // namespace ITF


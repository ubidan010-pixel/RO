#include "precompiled_editor.h"

#if defined(ITF_WINDOWS)

#ifndef _ITF_EDITOR_GUI_TEXTINPUT_H_
#include "editor\GUI.h"
#endif // _ITF_EDITOR_GUI_TEXTINPUT_H_

#ifndef _ITF_SYSTEMADAPTER_
#include "core/AdaptersInterfaces/SystemAdapter.h"
#endif //_ITF_SYSTEMADAPTER_

namespace ITF
{

    ///////////////////////////////////////////////////////////////////////////////////////////
    ///GUI for text input. We use a binarized resource file.
    static unsigned char binarizedInputBoxResource[] =
    {
        0x01,0x00,0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xc8,0x00,0xc8,0x00,0x05,
        0x00,0x16,0x00,0x11,0x00,0xe7,0x00,0x46,0x00,0x00,0x00,0x00,0x00,0x49,0x00,0x6e,
        0x00,0x70,0x00,0x75,0x00,0x74,0x00,0x00,0x00,0x08,0x00,0xbc,0x02,0x00,0x00,0x4d,
        0x00,0x53,0x00,0x20,0x00,0x53,0x00,0x68,0x00,0x65,0x00,0x6c,0x00,0x6c,0x00,0x20,
        0x00,0x44,0x00,0x6c,0x00,0x67,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x80,0x00,0x02,0x50,0x06,0x00,0x04,0x00,0x9d,0x00,0x21,0x00,0xe8,
        0x03,0x00,0x00,0xff,0xff,0x82,0x00,0x45,0x00,0x6e,0x00,0x74,0x00,0x65,0x00,0x72,
        0x00,0x20,0x00,0x73,0x00,0x74,0x00,0x72,0x00,0x69,0x00,0x6e,0x00,0x67,0x00,0x20,
        0x00,0x3a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,
        0x00,0x81,0x50,0x06,0x00,0x25,0x00,0xd8,0x00,0x0e,0x00,0xe9,0x03,0x00,0x00,0xff,
        0xff,0x81,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,
        0x00,0x03,0x50,0x76,0x00,0x34,0x00,0x33,0x00,0x0e,0x00,0x01,0x00,0x00,0x00,0xff,
        0xff,0x80,0x00,0x4f,0x00,0x4b,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x03,0x50,0xab,0x00,0x34,0x00,0x33,0x00,0x0e,0x00,0x02,
        0x00,0x00,0x00,0xff,0xff,0x80,0x00,0x43,0x00,0x41,0x00,0x4e,0x00,0x43,0x00,0x45,
        0x00,0x4c,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x02,0x40,0x00,0x00,0x27,0x00,0x08,0x00,0x08,0x00,0xff,0xff,0xff,0xff,0xff,
        0xff,0x82,0x00,0x00,0x00,0x00,0x00
    };
    static const int inputBox_IdLabel = 1000;
    static const int inputBox_IdEdit = 1001;

    static wchar_t g_InputText[256];

    struct LPARAM_tb
    {
        LPARAM_tb()
            : m_title(NULL)
            , m_message(NULL)
            , m_defaultText(NULL)
        {}

        const String* m_title;
        const String* m_message;
        const String* m_defaultText;
    };

    static LRESULT CALLBACK DlgProc(HWND hDlg, UINT message, WPARAM wParam, LPARAM lParam)
    {
        switch (message)
        {
        case WM_INITDIALOG:
            {
                LPARAM_tb* params = (LPARAM_tb*)lParam;
                ITF_ASSERT_MSG(params->m_title && params->m_message && params->m_defaultText, "LPARAM is not properly filled");

                SetWindowText(hDlg, (LPCWSTR)params->m_title->cStr());
                SetWindowText(GetDlgItem(hDlg, inputBox_IdLabel), (LPCWSTR)params->m_message->cStr());
                SetWindowText(GetDlgItem(hDlg, inputBox_IdEdit), (LPCWSTR)params->m_defaultText->cStr());
                return TRUE;
            }

        case WM_COMMAND:
            {
                INT_PTR buttonId = LOWORD(wParam);
                if (buttonId == IDOK)
                {
                    GetWindowText(GetDlgItem(hDlg, inputBox_IdEdit), g_InputText, sizeof(g_InputText)/sizeof(g_InputText[0]));
                    ::EndDialog(hDlg, buttonId);
                    return TRUE;
                }
                else if (buttonId == IDCANCEL)
                {
                    g_InputText[0]=0;
                    ::EndDialog(hDlg, buttonId);
                    return TRUE;
                }
            }
            break;
        }
        return FALSE;
    }

    ///////////////////////////////////////////////////////////////////////////////////////////
    bbool GUI_TextInput::inputText(const String& _title, const String& _message, String& _text)
    {
        FullScreenDialog_ProtectScope fullscreenGuard;

        HINSTANCE hInst = (HINSTANCE) ::GetModuleHandle(NULL);
        HWND hWndParent = (HWND)SYSTEM_ADAPTER->getMainWindow();
        LPDLGTEMPLATE dlgTemplate=(LPDLGTEMPLATE)binarizedInputBoxResource;

        LPARAM_tb params;
        params.m_title          = &_title;
        params.m_message        = &_message;
        params.m_defaultText    = &_text;

        INT_PTR r = ::DialogBoxIndirectParam(hInst, dlgTemplate, hWndParent, (DLGPROC)DlgProc, (LPARAM)&params);

        if (IDOK == r)
        {
            _text = (u16*)g_InputText;
            return btrue;
        }
        return bfalse;
    }

} //namespace ITF

#endif // ITF_WINDOWS
